<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <titleitle>
        <style>
            * {
                padding: 0;
                margin: 0;
                box-sizing: border-box;
            }

            body {
                padding: 200px;
            }

            nav {
                width: 350px;
                height: 365px;
                /* overflow: hidden; */
            }

            main {
               
                width:55550000px;
            }

            .div {
                width: 350px;
                /* height: 302px; */
                float: left;
                position: relative;
               box-sizing: border-box;
                /* transform: translateX() */
            }

            h4 {
                display: flex;
                justify-content: space-between;
                /* width: 100% */
            }

            .active {
                background: #666;
            }

            .month {
                position: absolute;
                top: -41px;
                left: 142px;
                z-index: 1;
            }

            .show {
                transition: all 1s;
                opacity: 1;
            }

            .hide {
                opacity: 0.8;
            }

            button {
                background: #38ca73;
                opacity: .8;
            }

            .week {
                display: flex;
                justify-content: space-between;
            }

            nav .week span {
                font-size: 14px;
            }

           
           
            main span{
                display:inline-block;
                border:1px solid yellow;
                width:50px;
                 height:50px;
                 text-align:center;
                 line-height:50px;
                 box-sizing: border-box;
            }
             main span.span {
                background: #666
            }
             main span.red {
                background: red
            }
        </style>
</head>

<body>
    <nav>
        <h4>
            <button>上一月</button>
            <span></span>
            <button>下一月</button>
        </h4>
        <h5 class="week">
            <span>星期天</span>
            <span>星期一</span>
            <span>星期二</span>
            <span>星期三</span>
            <span>星期四</span>
            <span>星期五</span>
            <span>星期六</span>
        </h5>
        <main>

        </main>
    </nav>
    <!-- <footer> -->
        <input type="text" class="text">
        <div class='selectdate'>提交</div>
    <!-- </footer> -->

    <script>
        // 启动计时器
        console.time('usetime');

        // 获取初始和结束日期
        let time = new Date(2018, 9, 2)
        let timeFinall = new Date(2100, 12, 31)

        // var Arr = []
        // Arr.push(time, timeFinall)
        var date1 = time.getFullYear() * 12 + time.getMonth();
        var date2 = timeFinall.getFullYear() * 12 + timeFinall.getMonth();
        // 获取月份总数
        var MonthOut = date2 - date1 + 1

        var Timeout = Math.floor((timeFinall - time) / 1000 / 60 / 60 / 24);
        var arr = []

        //  获取今天  
        let nowDay = new Date()
        // let nowDay = new Date("2018-12-31")
        //  let nowDay = new Date("2018-11-30")
        let day = nowDay.getDate()
        let Day;
        // 获取某一天到今天的天数
        var timer = Date.parse(nowDay);
        var lasttime = Date.parse("2018-09-02");

        //  加上1
        var dayOut = Math.floor((timer - lasttime) / (1000 * 60 * 60 * 24) + 1);

        // 处理月份  
        function ProcessingMonth(arr) {
            for (let i = 0; i < MonthOut; i++) {
                if (!arr[i]) {
                    arr[i] = []
                    // 特殊处理第一月
                    if (arr.length === 1) {
                        for (let j = time.getDate(); j < Timeout; j++) {
                            if (j > 30) {
                                break;
                            }
                            arr[i].push(j)
                        }
                    }
                    var Year = time.getFullYear()

                    var Month = time.getMonth() + i

                    Year += Math.ceil(Month / 12) + 1

                    // 判断是否是闰年
                    function isLeapYear(year) {
                        return year % 4 === 0 && year % 100 !== 0 && Month % 12 == 2
                    }
                    // 找出每月的天数
                    function days(Year, Month) {
                        var dayCount;
                        now = new Date(Year, Month, 0);
                        dayCount = now.getDate();
                        return dayCount;
                    }
                    if (isLeapYear(Year)) {

                        let p = days(Year, Month) + 1
                        for (let j = 1; j <= p; j++) {
                            arr[i].push(j)
                        }
                    } else {
                        for (let j = 1; j <= days(Year, Month); j++) {

                            if (i) {
                                arr[i].push(j)
                            }
                        }
                    }

                }

            }
        }

        ProcessingMonth(arr)

        let doc = document
        var main = doc.querySelector('main')

        // 生成dom元素
        function CreateDom() {

            for (let i = 0; i < arr.length; i++) {

                let div = doc.createElement('div')
                main.appendChild(div)
                div.classList.add('div')
                // Fragment.appendChild(div)
                let p = doc.createElement('p')
                p.classList.add('month')
                div.appendChild(p)

                let fragment = doc.createDocumentFragment()

                for (let j = 0; j < arr[i].length; j++) {
                    let span = doc.createElement('span')
                    span.innerText = arr[i][j]
                    fragment.appendChild(span)
                }
                div.appendChild(fragment)
            }
        }

        CreateDom();
            

        let SelectDate = document.querySelector('.selectdate')
        var text, finalltime;
        var textDayOut;
        SelectDate.onclick = () => {
            text = document.querySelector('.text').value
            let TextStr = []
            if (text) {
                let yearText = text.slice(0, 4)
                let monthDayText = text.slice(4)
                var inputText = monthDayText.split('')

                let input1 = "" + inputText[0] + inputText[1]
                let input2 = "" + inputText[2] + inputText[3]

                TextStr.push(yearText, input1, input2)
            }

            finalltime = new Date(TextStr.join(','))

            let date1 = finalltime.getFullYear() * 12 + finalltime.getMonth() + 1
            let date2 = time.getFullYear() * 12 + time.getMonth()

            textDayOut = date1 - date2 
           console.log(textDayOut);
           
            Day = finalltime.getDate() + ''
           
            currentIndex.call(this, textDayOut, Day)
            ShowCurrentDay.call(this, currentIndex(textDayOut))
            move.call(this, currentIndex(textDayOut))

        }

        let array = arr.concat()

        var div = main.querySelector('div')
        let width = 350;
        // main.style.width = div.offsetWidth * arr.length + 'px'

        // 计算出当前index
        function currentIndex() {
            if (typeof textDayOut === 'number') {
                for (let i = 0; i < array.length; i++) {
                    if (textDayOut === i) {
                        return i
                    }
                }
            }else{
                var Index = 1;
                var prams = dayOut
                for (let i = 0; i < array.length; i++) {
                    for (let j = 1; j <= array[i].length; j++) {
                        if (Index === prams) {
                            return i
                        }
                        Index++
                    }
                }
            }
           
        }

        // 显示当前日期
        function ShowCurrentDay(Index) {
            
            if(main.style.transition){
                main.style.transition = 'none'
            }

            main.style.transform = `translateX(${-currentIndex() * width}px)`
            
            if (typeof textDayOut === 'number') {
                var oDiv = doc.querySelectorAll('div')[currentIndex()];
                let spans = oDiv.querySelectorAll('span')

                for (let i = 0; i < spans.length; i++) {
                    if (spans[i].className == 'red') {
                        spans[i].classList.remove('red')
                    }
                    if (spans[i].innerText === Day) {
                        let d = spans[i]
                        if (!d.className) {
                            d.classList.add('red')
                        }
                    }
                }
            }else{
                let res = []
                arr.forEach((val, index) => {
                    val.forEach((value, i) => {
                        const element = value
                        res.push(element)
                        if (dayOut == res.length) {
                            var oDiv = doc.querySelectorAll('div')[index];
                            const span = oDiv.querySelectorAll('span')[i];
                            span.classList.add('red')
                            span.setAttribute('title', '今天')
                        }
                    })
                })
            }
           
        }

        ShowCurrentDay(dayOut)

        //  点击左右移动  
        function move(currentIndex) {

            let index = currentIndex

            var btn = doc.getElementsByTagName('h4')[0].getElementsByTagName('button')
            const [btn1, btn2] = [...btn]

            btn1.addEventListener('click', function () {
                index--
                if (index < 0) {
                    index = 0
                }
                main.style.transition = 'all 1s'
                main.style.transform = `translateX(${-index * width}px)`

            }, false)

            btn2.addEventListener('click', () => {
                index++

                if (index > arr.length - 1) {
                    index = arr.length - 1
                }
                main.style.transition = 'all 1s'
                main.style.transform = `translateX(${-index * width}px)`
            }, false)
        }
        move(currentIndex())

        var div = doc.querySelectorAll('div')

        //  补充不是当前月份的日期
        function vacancy() {

            for (let i = 1; i < arr.length; i++) {
                var result = 7 - arr[i - 1].length % 7
                var res = arr[i - 1].length % 7

                var div = document.querySelectorAll('div')
                var spanElement = div[i].getElementsByTagName('span');

                for (let k = 1; k <= res; k++) {

                    arr[i].unshift(arr[i - 1][arr[i - 1].length - k])
                    var span = document.createElement('span')
                    span.innerText = arr[i - 1][arr[i - 1].length - k]
                    span.classList.add('span')
                    div[i].insertBefore(span, spanElement[0])
                }

                for (let j = 1; j <= result; j++) {

                    arr[i - 1].push(j)
                    var span = document.createElement('span')
                    span.innerText = j
                    span.classList.add('span')
                    div[i - 1].appendChild(span)
                }

            }

        }
        vacancy()
        // 显示年月

        function showYearMonth() {

            // var odiv = doc.getElementsByTagName('div')
            var div = doc.querySelectorAll('div')
            for (let i = 0; i < div.length; i++) {
                var p = div[i].querySelectorAll('p')[0]
                var Month = time.getMonth() + i;
                var Year = time.getFullYear()

                // var Hours = nowDay.getHours();
                // var Minute = nowDay.getMinutes()
                // Minute = Minute > 9 ? Minute : 0 + '' + Minute;
                Year = Year + Math.ceil(Month / 12) - 1

                if (Month % 12 === 0) {
                    Month = 12;
                } else {
                    Month = Month % 12 < 10 ? '0' + Month % 12 : Month % 12
                }
                    p.innerText = Year + ':' + Month;
            }
        }
        showYearMonth()
        // 停止计时，输出时间
                console.timeEnd('usetime');


    </script>
</body>

</html>